{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Edit Product | {{ product.product_name }}</title>

    <link rel="stylesheet" href="{% static 'css/admin_style.css' %}">
    <link rel="stylesheet" href="{% static 'css/wizard.css' %}">
    <link rel="stylesheet" href="{% static 'css/lists.css' %}">
    <style>
        .accordion {
            background-color: #f9f9f9;
            color: #333;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: 1px solid #ddd;
            text-align: left;
            outline: none;
            font-size: 16px;
            font-weight: 600;
            transition: 0.4s;
            border-radius: 5px;
            margin-top: 20px;
        }

        .active,
        .accordion:hover {
            background-color: #eee;
        }

        .accordion:after {
            content: '\25BC';
            font-size: 13px;
            color: #777;
            float: right;
            margin-left: 5px;
        }

        .active:after {
            content: "\25B2";
        }

        .panel {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }

        .panel-content {
            padding: 20px 0;
        }
    </style>
</head>

<body>

    <!-- Nav Bar -->
    {% include "admin_navbar.html" %}

    <!-- ================= MAIN ================= -->
    <main class="main">

        <div class="topbar">
            <h2>Edit Product</h2>
        </div>

        <div class="card">

            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <p class="alert {{ message.tags }}">{{ message }}</p>
                {% endfor %}
            </div>
            {% endif %}

            <h3>Edit Product Details</h3>

            <form method="POST" action="/admin/edit-product/{{ product.slug }}/" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="product_id" value="{{ product.product_id }}">

                <h4>Product Details</h4>

                <label>Product Name</label>
                <input type="text" name="product_name" value="{{ product.product_name }}" required>

                <label>Description</label>
                <textarea name="description" required>{{ product.description }}</textarea>

                <label>Category</label>
                <input type="text" value="{{ product.category.category_name }}" readonly
                    style="background-color: #f0f0f0; cursor: not-allowed; color: #666;">
                <input type="hidden" name="category_id" value="{{ product.category.category_id }}">

                <label style="display:flex; align-items:center; gap:10px; margin-top:15px;">
                    <input type="checkbox" name="is_active" {% if product.is_active %}checked{% endif %}>
                    Active Status
                </label>

                <br><br>

                <hr style="margin-top:20px; margin-bottom:20px;">
                <h4>Product Images</h4>

                <div style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px;">
                    {% for img in product.images %}
                    <div style="border:1px solid #ddd; padding:10px; border-radius:5px; text-align:center;">
                        <img src="https://res.cloudinary.com/diipo18tm/{{ img.image }}"
                            style="width:100px; height:100px; object-fit:cover; border-radius:4px; display:block; margin-bottom:10px;">
                        {% if img.is_primary %}
                        <span
                            style="background-color:#28a745; color:white; padding:2px 8px; border-radius:3px; font-size:12px; display:inline-block; margin-bottom:5px;">Primary</span><br>
                        {% endif %}
                        <a href="/admin/delete-product-image/{{ img.id }}/{{ product.slug }}/" class="btn-sm delete"
                            onclick="return confirm('Delete this image?');"
                            style="display:inline-block; margin-top:5px; text-decoration:none;">Delete</a>
                    </div>
                    {% empty %}
                    <p style="color:#666; font-size:14px;">No images uploaded.</p>
                    {% endfor %}
                </div>

                <label>Add New Images</label>
                <input type="file" name="new_images" multiple accept="image/*" style="margin-bottom:15px;" />

                <br><br>

                <button type="submit" class="btn btn-green">
                    Update Product Details
                </button>

            </form>

            <hr style="margin-top:30px;">

            <!-- VARIANTS ACCORDION (Hidden/Collapsed by default) -->
            <button class="accordion">Manage Variants (Step 2)</button>
            <div class="panel">
                <div class="panel-content">
                    <div class="table-header"
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h4>Product Variants</h4>
                        <a href="/admin/add-variant/{{ product.slug }}" class="btn btn-green">+ Add Variant</a>
                    </div>

                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Compare Price</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for variant in product.variants %}
                            <tr>
                                <td>
                                    {% if variant.images %}
                                    <img src="https://res.cloudinary.com/diipo18tm/{{ variant.images.0.image }}"
                                        class="product-thumb" style="width:50px; border-radius:4px;" alt="">
                                    {% else %}
                                    <span style="color:#999;font-size:12px;">No Image</span>
                                    {% endif %}
                                </td>
                                <td>{{ variant.name }}</td>
                                <td>₹{{ variant.price }}</td>
                                <td>
                                    {% if variant.compare_at_price %}
                                    ₹{{ variant.compare_at_price }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>{{ variant.stock }}</td>
                                <td class="actions">
                                    <a href="/admin/edit-variant/{{ variant.id }}" class="btn-sm edit">Edit</a>
                                    <a href="/admin/delete-variant/{{ variant.id }}" class="btn-sm delete"
                                        onclick="return confirm('Are you sure you want to delete this variant?');">Delete</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="empty">No variants found for this product.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <script>
        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function () {
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                if (panel.style.maxHeight) {
                    panel.style.maxHeight = null;
                } else {
                    panel.style.maxHeight = panel.scrollHeight + "px";
                }
            });
        }
    </script>
    <script src="{% static 'js/admin_script.js'%}"></script>

</body>

</html>